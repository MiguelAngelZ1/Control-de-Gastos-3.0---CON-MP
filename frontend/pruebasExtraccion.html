<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Extractor SCPL / Camuzzi</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px }
.container { background:#fff; padding:20px; border-radius:8px; max-width:900px; margin:auto }
pre { background:#222; color:#0f0; padding:15px; border-radius:6px }
</style>
</head>

<body>
<div class="container">
<h2>Extractor de Facturas (SCPL / Camuzzi)</h2>
<input type="file" id="file">
<button onclick="procesar()">Procesar</button>
<pre id="out"></pre>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

async function leerPDF(file) {
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  let text = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const c = await page.getTextContent();
    text += c.items.map(i => i.str).join(' ') + '\n';
  }
  return text;
}

function normalizar(txt) {
  return txt
    .replace(/\r/g, '\n')
    .replace(/[^\S\n]+/g, ' ')
    .trim()
    .split('\n')
    .map(l => l.trim())
    .filter(Boolean);
}

/* ================== DETECCIÓN EMPRESA ================== */
function detectarEmpresa(lines) {
  const txt = lines.join(' ').toUpperCase();
  if (txt.includes('CAMUZZI')) return 'CAMUZZI';
  if (txt.includes('SOCIEDAD COOPERATIVA POPULAR')) return 'SCPL';
  return 'DESCONOCIDA';
}

/* ================== CÓDIGO DE PAGO ================== */
function extraerCodigo(lines) {
  const nums = [];
  for (const l of lines) {
    const m = l.match(/\d{30,}/g);
    if (m) nums.push(...m);
  }
  return nums.sort((a,b)=>b.length-a.length)[0] || null;
}

/* ================== MONTO ================== */
function extraerMonto(lines) {
  for (let i=0;i<lines.length;i++) {
    if (/TOTAL A PAGAR/i.test(lines[i])) {
      const m = lines[i+1]?.match(/\$ ?[\d\.]+,\d{2}/);
      if (m) return m[0];
    }
  }
  return null;
}

/* ================== TITULAR ================== */
function extraerTitular(lines) {
  const prohibidas = /FACTURA|GAS|SERVICIO|OFICINA|CENTRO|TOTAL/i;
  for (let i=0;i<lines.length;i++) {
    const l = lines[i];
    if (/^[A-ZÁÉÍÓÚÑ]{3,}( [A-ZÁÉÍÓÚÑ]{3,}){1,3}$/.test(l)
        && !prohibidas.test(l)
        && /\d{3,}|CALLE|AV|CHACABUCO/i.test(lines[i+1]||'')) {
      return l;
    }
  }
  return null;
}

/* ================== VENCIMIENTO ================== */
function extraerVencimientoSCPL(lines, codigo) {
  const idx = lines.findIndex(l => l.includes(codigo));
  if (idx === -1) return null;

  for (let o=-3;o<=3;o++) {
    const l = lines[idx+o];
    if (!l) continue;
    const m = l.match(/\d{2}\/\d{2}\/\d{2,4}/);
    if (m && !/PERIODO|EMISION|LECTURA/i.test(l)) {
      return m[0];
    }
  }
  return null;
}

function extraerVencimientoCamuzzi(lines) {
  for (let i=0;i<lines.length;i++) {
    if (/HASTA CUANDO PUEDO PAGAR/i.test(lines[i])) {
      const m = lines[i+1]?.match(/\d{2}\/\d{2}\/\d{4}/);
      if (m) return m[0];
    }
  }
  return null;
}

/* ================== MAIN ================== */
async function procesar() {
  const f = document.getElementById('file').files[0];
  if (!f) return;

  const raw = await leerPDF(f);
  const lines = normalizar(raw);

  const empresaTipo = detectarEmpresa(lines);
  const codigo = extraerCodigo(lines);
  const monto = extraerMonto(lines);
  const titular = extraerTitular(lines);

  let vencimiento = null;
  let empresaNombre = null;

  if (empresaTipo === 'SCPL') {
    empresaNombre = 'Sociedad Cooperativa Popular Limitada';
    vencimiento = extraerVencimientoSCPL(lines, codigo);
  }

  if (empresaTipo === 'CAMUZZI') {
    empresaNombre = 'Camuzzi Gas';
    vencimiento = extraerVencimientoCamuzzi(lines);
  }

  document.getElementById('out').textContent =
JSON.stringify({
  empresa: empresaNombre,
  titular,
  monto,
  vencimiento,
  codigoPago: codigo
}, null, 2);
}
</script>
</body>
</html>
